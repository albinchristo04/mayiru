name: Fetch TVTap All Channels

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      resolve_streams:
        description: 'Resolve stream URLs (slower)'
        required: false
        type: boolean
        default: false
      country_filter:
        description: 'Filter by country code (e.g., IT, US, UK) - leave empty for all'
        required: false
        type: string
      limit:
        description: 'Limit number of channels (for testing)'
        required: false
        type: number
  push:
    branches:
      - main
    paths:
      - 'tvtap_all_channels.py'
      - '.github/workflows/fetch-all-channels.yml'

jobs:
  fetch-all-channels:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pycryptodome pyDes
      
      - name: Fetch all channels (metadata only)
        if: github.event.inputs.resolve_streams != 'true' && !github.event.inputs.country_filter && !github.event.inputs.limit
        run: |
          python tvtap_all_channels.py > channels_all.json 2> fetch.log
      
      - name: Fetch channels with custom options
        if: github.event.inputs.resolve_streams == 'true' || github.event.inputs.country_filter || github.event.inputs.limit
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.resolve_streams }}" == "true" ]; then
            ARGS="$ARGS --resolve-streams"
          fi
          if [ -n "${{ github.event.inputs.country_filter }}" ]; then
            ARGS="$ARGS --country ${{ github.event.inputs.country_filter }}"
          fi
          if [ -n "${{ github.event.inputs.limit }}" ]; then
            ARGS="$ARGS --limit ${{ github.event.inputs.limit }}"
          fi
          python tvtap_all_channels.py $ARGS > channels_all.json 2> fetch.log
      
      - name: Display fetch log
        if: always()
        run: cat fetch.log
      
      - name: Generate country-specific files
        run: |
          # Extract each country into separate file
          python -c "
          import json
          with open('channels_all.json', 'r') as f:
              data = json.load(f)
          
          # Save each country separately
          for country, channels in data['channels_by_country'].items():
              country_data = {
                  'metadata': {
                      'timestamp': data['metadata']['timestamp'],
                      'country': country,
                      'total_channels': len(channels)
                  },
                  'channels': channels
              }
              with open(f'channels_{country}.json', 'w') as cf:
                  json.dump(country_data, cf, ensure_ascii=False, indent=2)
          
          print(f'Generated files for {len(data[\"channels_by_country\"])} countries')
          " 2>&1 | tee country_split.log
      
      - name: Generate channel statistics
        run: |
          python -c "
          import json
          
          with open('channels_all.json', 'r') as f:
              data = json.load(f)
          
          stats = {
              'timestamp': data['metadata']['timestamp'],
              'total_channels': data['metadata']['total_channels'],
              'total_countries': data['metadata']['countries_count'],
              'countries': {}
          }
          
          for country, channels in data['channels_by_country'].items():
              stats['countries'][country] = {
                  'channel_count': len(channels),
                  'channel_names': [ch['name'] for ch in channels]
              }
          
          with open('statistics.json', 'w') as f:
              json.dump(stats, f, ensure_ascii=False, indent=2)
          
          # Generate README stats
          with open('STATS.md', 'w') as f:
              f.write('# TVTap Channels Statistics\n\n')
              f.write(f'**Last Updated:** {data[\"metadata\"][\"timestamp\"]}\n\n')
              f.write(f'**Total Channels:** {data[\"metadata\"][\"total_channels\"]}\n\n')
              f.write(f'**Total Countries:** {data[\"metadata\"][\"countries_count\"]}\n\n')
              f.write('## Channels by Country\n\n')
              
              for country in sorted(stats['countries'].keys()):
                  count = stats['countries'][country]['channel_count']
                  f.write(f'- **{country}**: {count} channels\n')
          
          print('Statistics generated successfully')
          " 2>&1 | tee stats.log
      
      - name: Upload all channels JSON as artifact
        uses: actions/upload-artifact@v4
        with:
          name: tvtap-all-channels-${{ github.run_number }}
          path: |
            channels_all.json
            channels_*.json
            statistics.json
            STATS.md
            *.log
          retention-days: 90
      
      - name: Commit and push if changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all generated files
          git add -A
          
          # Check if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update TVTap channels - $(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
                       -m "Total channels: $(cat statistics.json | grep -o '\"total_channels\": [0-9]*' | grep -o '[0-9]*')" \
                       -m "Countries: $(cat statistics.json | grep -o '\"total_countries\": [0-9]*' | grep -o '[0-9]*')"
            git push
          else
            echo "No changes to commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  fetch-italian-channels-with-streams:
    runs-on: ubuntu-latest
    needs: fetch-all-channels
    if: github.event.schedule || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pycryptodome pyDes
      
      - name: Fetch Italian channels with streams
        run: |
          python tvtap_all_channels.py --country IT --resolve-streams > channels_IT_with_streams.json 2> fetch_it_streams.log
      
      - name: Display Italian streams log
        if: always()
        run: cat fetch_it_streams.log
      
      - name: Generate M3U playlist for Italian channels
        run: |
          python -c "
          import json
          
          with open('channels_IT_with_streams.json', 'r') as f:
              data = json.load(f)
          
          with open('italian_channels.m3u', 'w') as f:
              f.write('#EXTM3U\n')
              f.write('#EXTINF:-1,TVTap - Italian Channels\n\n')
              
              channels_added = 0
              for channel in data['channels_flat']:
                  if channel.get('stream_url'):
                      name = channel['name']
                      url = channel['stream_url'].split('|')[0]  # Clean URL
                      f.write(f'#EXTINF:-1,{name}\n')
                      f.write(f'{url}\n\n')
                      channels_added += 1
              
              print(f'M3U playlist created with {channels_added} channels')
          " 2>&1 | tee m3u_gen.log
      
      - name: Upload Italian channels with streams
        uses: actions/upload-artifact@v4
        with:
          name: tvtap-italian-streams-${{ github.run_number }}
          path: |
            channels_IT_with_streams.json
            italian_channels.m3u
            fetch_it_streams.log
            m3u_gen.log
          retention-days: 30
      
      - name: Commit Italian channels
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git pull
          git add channels_IT_with_streams.json italian_channels.m3u
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update Italian channels with streams - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
