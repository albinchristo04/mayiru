name: Fetch TVTap Sports Channels

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      resolve_streams:
        description: 'Resolve stream URLs (slower)'
        required: false
        type: boolean
        default: false
      country_filter:
        description: 'Filter by country code (e.g., IT, US, UK) - leave empty for all'
        required: false
        type: string
      max_streams:
        description: 'Max streams to resolve (to avoid timeout)'
        required: false
        type: number
        default: 100
  push:
    branches:
      - main
    paths:
      - 'tvtap_sports_fetcher.py'
      - '.github/workflows/fetch-sports-channels.yml'

jobs:
  fetch-sports-metadata:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pycryptodome pyDes
      
      - name: Fetch sports channels metadata
        run: |
          python tvtap_sports_fetcher.py > sports_channels.json 2> fetch.log
      
      - name: Display fetch log
        if: always()
        run: cat fetch.log
      
      - name: Generate country-specific files
        run: |
          python -c "
          import json
          
          with open('sports_channels.json', 'r') as f:
              data = json.load(f)
          
          for country, channels in data['channels_by_country'].items():
              country_data = {
                  'metadata': {
                      'timestamp': data['metadata']['timestamp'],
                      'country': country,
                      'type': 'sports_only',
                      'total_channels': len(channels)
                  },
                  'channels': channels
              }
              with open(f'sports_{country}.json', 'w') as cf:
                  json.dump(country_data, cf, ensure_ascii=False, indent=2)
          
          print(f'Generated files for {len(data[\"channels_by_country\"])} countries')
          " 2>&1 | tee country_split.log
      
      - name: Generate sports statistics
        run: |
          python -c "
          import json
          
          with open('sports_channels.json', 'r') as f:
              data = json.load(f)
          
          stats = {
              'timestamp': data['metadata']['timestamp'],
              'type': 'sports_channels',
              'total_sports_channels': data['metadata']['total_channels'],
              'total_countries': data['metadata']['countries_count'],
              'countries': {}
          }
          
          for country, channels in data['channels_by_country'].items():
              stats['countries'][country] = {
                  'channel_count': len(channels),
                  'channel_names': [ch['name'] for ch in channels]
              }
          
          with open('sports_statistics.json', 'w') as f:
              json.dump(stats, f, ensure_ascii=False, indent=2)
          
          with open('SPORTS_STATS.md', 'w') as f:
              f.write('# TVTap Sports Channels Statistics\n\n')
              f.write(f'**Last Updated:** {data[\"metadata\"][\"timestamp\"]}\n\n')
              f.write(f'**Total Sports Channels:** {data[\"metadata\"][\"total_channels\"]}\n\n')
              f.write(f'**Total Countries:** {data[\"metadata\"][\"countries_count\"]}\n\n')
              f.write('## Sports Channels by Country\n\n')
              
              sorted_countries = sorted(stats['countries'].items(), 
                                        key=lambda x: x[1]['channel_count'], 
                                        reverse=True)
              
              for country, info in sorted_countries:
                  count = info['channel_count']
                  f.write(f'### {country} ({count} channels)\n\n')
                  for name in sorted(info['channel_names']):
                      f.write(f'- {name}\n')
                  f.write('\n')
          
          print('Sports statistics generated successfully')
          " 2>&1 | tee stats.log
      
      - name: Upload sports metadata
        uses: actions/upload-artifact@v4
        with:
          name: tvtap-sports-metadata-${{ github.run_number }}
          path: |
            sports_channels.json
            sports_*.json
            sports_statistics.json
            SPORTS_STATS.md
            *.log
          retention-days: 90
      
    - name: Commit metadata changes
  run: |
    git config --local user.email "github-actions[bot]@users.noreply.github.com"
    git.config --local user.name "github-actions[bot]"

    # Stash ALL changes (tracked + untracked)
    git add -A
    git stash --include-untracked

    # Pull latest with rebase
    git pull --rebase origin main || true

    # Restore changes
    git stash pop || true

    git add -A

    if [ -n "$(git status --porcelain)" ]; then
      CHANNEL_COUNT=$(cat sports_statistics.json | grep -o '\"total_sports_channels\": [0-9]*' | grep -o '[0-9]*')
      COUNTRY_COUNT=$(cat sports_statistics.json | grep -o '\"total_countries\": [0-9]*' | grep -o '[0-9]*')

      git commit -m "Update sports channels metadata - $(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
                 -m "Total sports channels: $CHANNEL_COUNT" \
                 -m "Countries: $COUNTRY_COUNT"

      git push origin main
    else
      echo "No changes to commit"
    fi

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  fetch-popular-sports-streams:
    runs-on: ubuntu-latest
    needs: fetch-sports-metadata
    if: github.event.schedule || (github.event_name == 'workflow_dispatch' && github.event.inputs.resolve_streams == 'true')
    strategy:
      matrix:
        country: ['IT', 'US', 'UK', 'ES']
      fail-fast: false
    
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pycryptodome pyDes
      
      - name: Fetch sports streams for ${{ matrix.country }}
        run: |
          MAX_STREAMS=${{ github.event.inputs.max_streams || '50' }}
          python tvtap_sports_fetcher.py \
            --country ${{ matrix.country }} \
            --resolve-streams \
            --max-streams $MAX_STREAMS \
            --stream-delay 0.3 \
            > sports_${{ matrix.country }}_streams.json 2> fetch_${{ matrix.country }}_streams.log
        timeout-minutes: 25
      
      - name: Display stream fetch log
        if: always()
        run: cat fetch_${{ matrix.country }}_streams.log || echo "No log file"
      
      - name: Generate M3U playlist for ${{ matrix.country }}
        if: success()
        run: |
          python -c "
          import json
          import sys
          
          try:
              with open('sports_${{ matrix.country }}_streams.json', 'r') as f:
                  data = json.load(f)
              
              with open('sports_${{ matrix.country }}.m3u', 'w') as f:
                  f.write('#EXTM3U\n')
                  f.write('#EXTINF:-1,TVTap - ${{ matrix.country }} Sports Channels\n\n')
                  
                  channels_added = 0
                  for channel in data.get('channels_flat', []):
                      if channel.get('stream_url'):
                          name = channel['name']
                          url = channel['stream_url'].split('|')[0]
                          
                          f.write(f'#EXTINF:-1 tvg-name=\"{name}\" tvg-country=\"${{ matrix.country }}\",{name}\n')
                          f.write(f'{url}\n\n')
                          channels_added += 1
                  
                  print(f'M3U playlist created with {channels_added} channels')
          except Exception as e:
              print(f'Error creating M3U: {e}', file=sys.stderr)
              sys.exit(1)
          " 2>&1 | tee m3u_${{ matrix.country }}.log
      
      - name: Upload ${{ matrix.country }} sports streams
        uses: actions/upload-artifact@v4
        with:
          name: tvtap-sports-${{ matrix.country }}-streams-${{ github.run_number }}
          path: |
            sports_${{ matrix.country }}_streams.json
            sports_${{ matrix.country }}.m3u
            fetch_${{ matrix.country }}_streams.log
            m3u_${{ matrix.country }}.log
          retention-days: 30
      
      - name: Commit ${{ matrix.country }} streams
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git pull --rebase origin main
          
          git add sports_${{ matrix.country }}_streams.json sports_${{ matrix.country }}.m3u
          
          if [ -n "$(git.status --porcelain)" ]; then
            git.commit -m "Update ${{ matrix.country }} sports streams - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git.push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
